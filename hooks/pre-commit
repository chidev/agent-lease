#!/bin/bash
# agent-lease pre-commit hook
# Creates a validation gate that blocks commits until audit proof exists
# Bypass with: git commit --no-verify (USE SPARINGLY)

set -e

PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)

# Load config or use defaults
CONFIG_FILE="$PROJECT_ROOT/.agent-lease.json"
if [ -f "$CONFIG_FILE" ]; then
  PROJECT_NAME=$(grep -o '"projectName"[[:space:]]*:[[:space:]]*"[^"]*"' "$CONFIG_FILE" 2>/dev/null | cut -d'"' -f4)
  RAW_LOCK_DIR=$(grep -o '"lockDir"[[:space:]]*:[[:space:]]*"[^"]*"' "$CONFIG_FILE" 2>/dev/null | cut -d'"' -f4)
fi

# If no projectName in config, try package.json name, then dirname
if [ -z "$PROJECT_NAME" ]; then
  PKG_FILE="$PROJECT_ROOT/package.json"
  if [ -f "$PKG_FILE" ]; then
    PROJECT_NAME=$(grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' "$PKG_FILE" 2>/dev/null | head -1 | cut -d'"' -f4 | sed 's/[^a-zA-Z0-9_-]/-/g')
  fi
fi
PROJECT_NAME="${PROJECT_NAME:-$(basename "$PROJECT_ROOT")}"
RAW_LOCK_DIR="${RAW_LOCK_DIR:-auto}"

# Resolve lock dir (mirrors lib/config.js logic)
# Priority: env > config value > XDG > /tmp
if [ -n "$AGENT_LEASE_LOCK_DIR" ]; then
  LOCK_DIR="$AGENT_LEASE_LOCK_DIR"
elif [ "$RAW_LOCK_DIR" = "local" ]; then
  LOCK_DIR="$PROJECT_ROOT/.agent-lease/locks"
elif [ "$RAW_LOCK_DIR" = "auto" ] || [ "$RAW_LOCK_DIR" = "xdg" ]; then
  if [ -n "$XDG_RUNTIME_DIR" ]; then
    LOCK_DIR="$XDG_RUNTIME_DIR/agent-lease"
  else
    LOCK_DIR="/tmp"
  fi
else
  # Custom absolute path
  LOCK_DIR="$RAW_LOCK_DIR"
fi

# Override project name from env
if [ -n "$AGENT_LEASE_PROJECT" ]; then
  PROJECT_NAME="$AGENT_LEASE_PROJECT"
fi

# Ensure lock dir exists
mkdir -p "$LOCK_DIR"

# Get current commit hash (or 'new' for first commit)
SHORT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "new")
LOCK_FILE="$LOCK_DIR/agent-lease-$PROJECT_NAME-$SHORT_HASH.lock"

# Check if lock exists with audit proof
if [ -f "$LOCK_FILE" ]; then
  if grep -q "AUDIT_PROOF_PASSED" "$LOCK_FILE" 2>/dev/null; then
    echo ""
    echo "âœ… agent-lease: Validation proof found. Commit allowed."
    echo ""
    rm -f "$LOCK_FILE"
    exit 0
  else
    echo ""
    echo "âŒ COMMIT BLOCKED - Validation incomplete"
    echo ""
    echo "Lock exists but audit not completed: $LOCK_FILE"
    echo ""
    echo "To proceed, run validation:"
    echo ""
    echo "  npx agent-lease release --audit-proof"
    echo ""
    echo "To bypass (USE SPARINGLY):"
    echo ""
    echo "  git commit --no-verify"
    echo ""
    exit 1
  fi
fi

# No lock exists - create one and block
GUID=$(date +%s | shasum | head -c 12)
cat > "$LOCK_FILE" << EOF
LOCK_GUID=$GUID
CREATED=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
PROJECT=$PROJECT_NAME
PHASE=commit
STATUS=PENDING
EOF

cat << EOF

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ðŸ”’ AGENT-LEASE: COMMIT BLOCKED                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Validation required before commit can proceed.              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Lock: $LOCK_FILE

To release, run validation:

  npx agent-lease release --audit-proof

Then commit again:

  git commit -m "your message"

To bypass (USE SPARINGLY):

  git commit --no-verify

EOF

exit 1
